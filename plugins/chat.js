// Generated by CoffeeScript 1.10.0

/*

 插件支持两个方法调用
 init(robot)
 received(content,send,robot,message)
 stop(robot)

 1.直接使用
 module.exports = func 为快捷隐式调用 received 方法
 2.或
 module.exports = {
 init:      init_func       # 初始化调用
 received:  received_func   # 接受消息
 stop:      init_func       # 停止插件（比如端口占用）
 }
 */

(function() {
    var request = require('request');

    var apiUrl='http://www.tuling123.com/openapi/api';

    var param={
        "key":"a0643c898057d80d2ab6bb71e27e147d"
    }

    // fs = require('fs');

    // Path = require('path');

    var chat={};


    /*
     @param content 消息内容
     @param send(content)  回复消息
     @param robot qqbot instance
     @param message 原消息对象
     */

    module.exports = function(content, send, robot, message) {
        content=content.trim();
        if(content.match(/^m/gi)){
            console.log(content);
            content=content.substr(1);
            param.info=content;
            param.userid=message.from_uin;
            request.post({url:apiUrl,body: JSON.stringify(param)},function (e,r,b) {
                if(e){
                    return e;
                }else{

                    try{
                        var data =  JSON.parse(b);
                    }catch(ee){
                        var data = {
                            code:2333,
                            data:[]
                        }
                    }

                    if(data.text.length>0){
                        chat.text = data.text;

                        send('@'+message.from_user.nick+' '+chat.text);
                        return;
                    }else{
                        return 'data null';
                    }

                    console.log(data);
                }
            });

        }
    };

}).call(this);
